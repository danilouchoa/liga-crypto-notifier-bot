name: Label - Ready to Merge (Dependabot)

on:
  workflow_run:
    workflows: ['CI/CD - Liga Crypto Notifier Bot']
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  add-label-if-quality-check-passed:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Verificar se o job "Code Quality & Testes" foi bem-sucedido
        uses: actions/github-script@v7
        with:
          script: |
            const runId = ${{ github.event.workflow_run.id }};
            const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });

            const job = jobs.jobs.find(j => j.name === 'Code Quality & Testes');

            if (!job || job.conclusion !== 'success') {
              core.setFailed('O job "Code Quality & Testes" falhou ou nÃ£o foi encontrado.');
              return;
            }

            const prList = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `dependabot/${{ github.event.workflow_run.head_branch }}`
            });

            if (prList.data.length > 0) {
              const prNumber = prList.data[0].number;
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: ['ready-to-merge']
              });
              console.log(`Label aplicada ao PR #${prNumber}`);
            } else {
              console.log('Nenhum PR encontrado para essa branch.');
            }
