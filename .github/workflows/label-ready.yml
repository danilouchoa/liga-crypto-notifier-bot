name: Label - Ready to Merge (Dependabot)

on:
  workflow_run:
    workflows: ['CI/CD - Liga Crypto Notifier Bot']
    types: [completed]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  add-label-if-quality-check-passed:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Verificar se o job "Code Quality & Testes" foi bem-sucedido
        uses: actions/github-script@v7
        env:
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
          WORKFLOW_RUN_ID: ${{ github.event.workflow_run.id }}
        with:
          script: |
            if (!process.env.HEAD_BRANCH.startsWith('dependabot/')) {
              console.log('ğŸ” Branch nÃ£o Ã© do dependabot, abortando.');
              return;
            }

            const runId = process.env.WORKFLOW_RUN_ID;
            const maxAttempts = 10;
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            let qualityCheckJob;
            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: runId
              });

              qualityCheckJob = jobs.jobs.find(j => j.name === 'Code Quality & Testes');

              if (qualityCheckJob?.conclusion === 'success') {
                console.log(`âœ… Job 'Code Quality & Testes' finalizado com sucesso.`);
                break;
              }

              if (attempt === maxAttempts) {
                console.log('â›” Testes falharam. Fechando PR e comentando motivo.');

                const { data: prList } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  head: process.env.HEAD_BRANCH
                });

                if (prList.length > 0) {
                  const prNumber = prList[0].number;
                  await github.rest.pulls.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: prNumber,
                    state: 'closed'
                  });

                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: prNumber,
                    body: 'âŒ PR fechado automaticamente pois os testes nÃ£o passaram no job `Code Quality & Testes`.'
                  });
                }

                return;
              }

              console.log(`â³ Tentativa ${attempt}/10: aguardando finalizaÃ§Ã£o do job...`);
              await delay(5000);
            }

            const { data: prList } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: process.env.HEAD_BRANCH
            });

            if (prList.length === 0) {
              console.log(`âŒ Nenhum PR encontrado para a branch '${process.env.HEAD_BRANCH}'`);
              return;
            }

            const prNumber = prList[0].number;

            // ğŸ·ï¸ Adiciona label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['ready-to-merge']
            });

            // ğŸ’¬ Comenta resultado dos testes
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `âœ… Os testes no job \`Code Quality & Testes\` passaram com sucesso. PR pronto para merge.`
            });

            // ğŸ“¦ Verifica mudanÃ§as em package.json e comenta
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const pkgChanges = files.filter(f => f.filename.includes('package.json'));
            if (pkgChanges.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `ğŸ“¦ Foram detectadas mudanÃ§as em \`${pkgChanges.map(f => f.filename).join(', ')}\`. Verifique se as dependÃªncias estÃ£o seguras.`
              });
            }

            console.log(`ğŸ·ï¸ Label aplicada e comentÃ¡rios inseridos no PR #${prNumber}`);
